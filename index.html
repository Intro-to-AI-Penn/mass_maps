<!doctype html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>DES Y3 Multi-Resolution Mass Map</title>
    <script defer src="https://aladin.cds.unistra.fr/AladinLite/api/v3/latest/aladin.js"></script>
    <style>
      #aladin-lite-div { width: 700px; height: 400px; }
    </style>
  </head>

  <body>
    <h1>DES Y3 Multi-Resolution Mass Map</h1>
    <div id="aladin-lite-div"></div>

      <script src="https://aladin.cds.unistra.fr/AladinLite/api/v3/latest/aladin.js"></script>

      <script>
        A.init.then(async () => {
          const myHiPS = "https://Intro-to-AI-Penn.github.io/mass_maps/hips/";

        const aladin = A.aladin("#aladin-lite-div", {
          survey: "P/2MASS/color",
          name: "DES Wiener Tomographic Bin 4 Mass Map",
          target: "13h00m00s -55d00m00s",
          fov: 40,
          showReticle: true,
          showGotoControl: true,
          showLayersControl: true,
          showZoomControl: true,
          showFullscreenControl: true,
          opacity: 0.98
        });

        aladin.setProjection("MOL");

        // HiPS overlay layer
        aladin.setOverlayImageLayer(aladin.newImageSurvey(myHiPS, { opacity: 0.99 }), "wiener4");

        // Load your generated catalog (relative file in this repo)
        const resp = await fetch("patches_tom4.json");
        if (!resp.ok) throw new Error("Could not load patches_tom4.json: " + resp.status);
        const patches = await resp.json();

        console.log("Loaded patches:", patches.length);

        if (patches.length > 0) {
          console.log("First patch:", patches[0].name, patches[0].url, patches[0].wcs);
        }
        if (patches.length > 1) {
          console.log("Second patch:", patches[1].name, patches[1].url, patches[1].wcs);
        }

        // Check how many unique URLs you have (should be ~#patches)
        const uniqueUrls = new Set(patches.map(p => p.url));
        console.log("Unique patch URLs:", uniqueUrls.size);

        // Check how many unique centers you have (CRVAL1/CRVAL2 should vary)
        const uniqueCenters = new Set(patches.map(p => `${p.wcs.CRVAL1.toFixed(6)},${p.wcs.CRVAL2.toFixed(6)}`));
        console.log("Unique patch centers:", uniqueCenters.size);

        // Make patches semi-transparent so overlaps are obvious
        const PATCH_OPACITY = 0.45;

        // Add EVERY patch as its own overlay layer, with a unique layer id
        patches.forEach((p, idx) => {
          const img = A.image(p.url, {
            name: p.name,                 // shows in UI
            imgFormat: p.imgFormat || "png",
            wcs: p.wcs,
            opacity: PATCH_OPACITY
          });

          // IMPORTANT: give each overlay a unique id in Aladin's overlay list
          aladin.addOverlayImageLayer(img, `patch_${idx}`);
        });
      });
    </script>
  </body>
</html>