<!doctype html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>DES Y3 Multi-Resolution Mass Map</title>
    <script defer src="https://aladin.cds.unistra.fr/AladinLite/api/v3/latest/aladin.js"></script>
    <style>
      #aladin-lite-div { width: 700px; height: 400px; }
    </style>
  </head>

  <body>
    <h1>DES Y3 Multi-Resolution Mass Map</h1>
    <label for="patch-selector" style="display:block; margin: 8px 0;">
      Patch:
      <select id="patch-selector"></select>
    </label>
    <div id="aladin-lite-div"></div>

      <script src="https://aladin.cds.unistra.fr/AladinLite/api/v3/latest/aladin.js"></script>

      <script>
        A.init.then(async () => {
          const myHiPS = "https://Intro-to-AI-Penn.github.io/mass_maps/hips/";

        const aladin = A.aladin("#aladin-lite-div", {
          survey: "P/2MASS/color",
          name: "DES Wiener Tomographic Bin 4 Mass Map",
          target: "13h00m00s -55d00m00s",
          fov: 40,
          showReticle: true,
          showGotoControl: true,
          showLayersControl: true,
          showZoomControl: true,
          showFullscreenControl: true,
          opacity: 0.98
        });

        aladin.setProjection("MOL");

        // HiPS overlay layer
        aladin.setOverlayImageLayer(aladin.newImageSurvey(myHiPS, { opacity: 0.99 }), "wiener4");

        // Load catalog once
        const resp = await fetch("patches_tom4.json");
        if (!resp.ok) throw new Error("Could not load patches_tom4.json: " + resp.status);
        const patches = await resp.json();

        console.log("Loaded patches:", patches.length);

        const selector = document.getElementById("patch-selector");

        // Populate dropdown
        patches.forEach((p, idx) => {
          const opt = document.createElement("option");
          opt.value = String(idx);
          opt.textContent = p.name;
          selector.appendChild(opt);
        });

        // Make sure we can see what’s happening
        function showPatchByIndex(idx) {
          const p = patches[idx];
          console.log("Showing patch:", idx, p.name, p.url);

          // Replace the same overlay slot every time
          const img = A.image(p.url, {
            name: p.name,
            imgFormat: p.imgFormat || "png",
            wcs: p.wcs,
            opacity: 0.9
          });

          // This REPLACES the previous overlay with the same id ("active_patch")
          aladin.setOverlayImageLayer(img, "active_patch");

          // Always jump to the patch center so you definitely see a change
          aladin.gotoRaDec(p.wcs.CRVAL1, p.wcs.CRVAL2);

          // Set a reasonable FoV (don’t overdo it)
          if (p.radec_bounds && p.radec_bounds.length === 4) {
            const raSpan = Math.abs(p.radec_bounds[1] - p.radec_bounds[0]);
            const decSpan = Math.abs(p.radec_bounds[3] - p.radec_bounds[2]);
            const span = Math.max(raSpan, decSpan);
            if (isFinite(span) && span > 0) aladin.setFoV(span * 1.5);
          }
        }

        // Hook up the dropdown
        selector.addEventListener("change", (e) => {
          const idx = parseInt(e.target.value, 10);
          showPatchByIndex(idx);
        });

        // Show patch 0 initially
        selector.value = "0";
        showPatchByIndex(0);
      });
    </script>
  </body>
</html>