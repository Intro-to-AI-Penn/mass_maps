<!doctype html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>DES Y3 Multi-Resolution Mass Map</title>
    <script defer src="https://aladin.cds.unistra.fr/AladinLite/api/v3/latest/aladin.js"></script>
    <style>
      #aladin-lite-div { width: 700px; height: 400px; }
    </style>
  </head>

  <body>
    <h1>DES Y3 Multi-Resolution Mass Map</h1>
    <div id="aladin-lite-div"></div>

      <script src="https://aladin.cds.unistra.fr/AladinLite/api/v3/latest/aladin.js"></script>

      <script>
        A.init.then(async () => {
          const myHiPS = "https://Intro-to-AI-Penn.github.io/mass_maps/hips/";

        const aladin = A.aladin("#aladin-lite-div", {
          survey: "P/2MASS/color",
          name: "DES Wiener Tomographic Bin 4 Mass Map",
          target: "13h00m00s -55d00m00s",
          fov: 40,
          showReticle: true,
          showGotoControl: true,
          showLayersControl: true,
          showZoomControl: true,
          showFullscreenControl: true,
          opacity: 0.98
        });

        aladin.setProjection("MOL");

        // HiPS overlay layer
        aladin.setOverlayImageLayer(aladin.newImageSurvey(myHiPS, { opacity: 0.99 }), "wiener4");

        // Load your generated catalog (relative file in this repo)
        const resp = await fetch("patches_tom4.json");
        if (!resp.ok) throw new Error("Could not load patches_tom4.json: " + resp.status);
        const patches = await resp.json();

        console.log("Loaded patches:", patches.length);

        console.log("Loaded patches:", patches.length);
        console.log("Unique URLs:", new Set(patches.map(p => p.url)).size);
        console.log("Unique centers:", new Set(patches.map(p => `${p.wcs.CRVAL1.toFixed(6)},${p.wcs.CRVAL2.toFixed(6)}`)).size);

        // Make patches semi-transparent so overlaps are obvious
        const PATCH_OPACITY = 0.45;

        patches.forEach((p, idx) => {
          const layerId = `patch_${idx}`; // must be unique

          const img = A.image(p.url, {
            name: p.name,
            imgFormat: p.imgFormat || "png",
            wcs: p.wcs,
            opacity: PATCH_OPACITY
          });

          // IMPORTANT: unique id so it doesn't overwrite previous overlays
          aladin.setOverlayImageLayer(img, layerId);
        });

        aladin.setFoV(180);
      });
    </script>
  </body>
</html>